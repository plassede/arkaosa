<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

<style>
  :root{
    --bg:#0b0f15; --ink:#cfe6ff; --panel:#0f1726; --accent:#6bdcff; --muted:#24344e;
    --purple:#a56bff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden}
  canvas{display:block}

  /* HUD (data + botão) */
  .hud{
    position:fixed; right:1rem; top:1rem; display:grid; gap:.6rem;
    background:color-mix(in oklab, #0c1320 80%, transparent);
    backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px);
    padding:.8rem .9rem; border:1px solid var(--muted); border-radius:.75rem;
    font-size:clamp(.9rem,.85rem + .2vw,1rem);
    box-shadow:0 12px 28px rgba(0,0,0,.35)
  }
  .row{display:grid;grid-template-columns:auto 1fr;gap:.6rem;align-items:center}
  .hud input{
    background:#0e1522; border:1px solid #1e2b46; color:var(--ink);
    border-radius:.5rem; padding:.5rem .65rem; width:clamp(10rem,28vw,13rem)
  }
  .hud button{
    cursor:pointer; background:linear-gradient(135deg,var(--accent),#8be1ff);
    color:#05222c; border:0; border-radius:.6rem; padding:.6rem .9rem; font-weight:800;
    box-shadow:0 10px 24px rgba(0,0,0,.25)
  }
  .hud button[disabled]{opacity:.55; cursor:not-allowed; filter:grayscale(.35)}

  /* Barra inferior (mensagem + timer) */
  .status{
    position:fixed; left:0; right:0; bottom:calc(.75rem + env(safe-area-inset-bottom));
    display:flex; justify-content:center; pointer-events:none; padding:0 .75rem;
  }
  .status-inner{
    display:flex; align-items:center; gap:.65rem;
    background:color-mix(in oklab, #0f1726 85%, transparent); border:1px solid var(--muted);
    border-radius:999px; padding:.55rem .95rem; font-weight:700; box-shadow:0 10px 30px rgba(0,0,0,.25);
    max-width:min(92vw,900px)
  }
  #statusText{white-space:nowrap; text-overflow:ellipsis; overflow:hidden}
  .timer{
    display:inline-flex; align-items:center; justify-content:center; min-width:2.2rem; height:2.2rem;
    border-radius:999px; background:#13203a; border:1px solid #233656; font-variant-numeric:tabular-nums;
  }

  /* Modal */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:1rem}
  .modal{
    width:min(820px,100%); max-height:calc(100dvh - 2rem); overflow:auto;
    background:linear-gradient(180deg,#0f1726 0%, #0d1421 100%);
    border:1px solid var(--muted); border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.45); padding:0;
  }
  .modal-head{
    padding:1.1rem 1.2rem;
    background:linear-gradient(135deg, rgba(107,220,255,.18), rgba(176,132,255,.15));
    border-bottom:1px solid #1e2b46;
  }
  .modal-title{margin:0; font-size:clamp(1.05rem,1rem + .4vw,1.3rem)}
  .modal-body{padding:1rem 1.2rem 1.2rem 1.2rem}

  .bigCounter{
    font-size:clamp(2.2rem,1.6rem + 3.5vw,3rem); 
    font-weight:900; letter-spacing:.5px;
    background:linear-gradient(90deg,#cfe6ff,#9ad3ff); 
    -webkit-background-clip:text; 
    background-clip:text; 
    color:transparent
  }

  .chip{
    font-size: medium;
    display:inline-flex; 
    align-items:center; 
    font-weight:800; 
    border-radius:999px; 
    padding:4px 16px 4px 16px; border:1px solid;
    height:fit-content;
    margin-top: auto;
    margin-bottom: auto;
    margin-left: 2%;
  }

  .chaos-badge{
    color:#fff; 
    background:color-mix(
      in oklab, 
      var(--purple) 85%, #000 15%
      ); 
      border-color:#a56bff66
    }

  .influencia{display:flex; flex-wrap:wrap; gap:.6rem 1rem; align-items:center}
  .signo{display:flex; align-items:center; gap:.5rem}
  .seta{opacity:.7}

  .traits{display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.35rem}
  .tag{background:#111a28; border:1px solid #24344e; color:var(--ink);
       padding:.35rem .6rem; border-radius:.55rem; font-size:clamp(.85rem,.8rem + .2vw,.95rem)}

  .fortune{margin-top:.8rem; font-size:clamp(.95rem,.9rem + .2vw,1.05rem); opacity:.95}
  .closebar{display:flex; justify-content:flex-end; padding:1rem 1.2rem 1.2rem 1.2rem; border-top:1px solid #1e2b46}
  .closebtn{background:#152238; border:1px solid #2a3c5a; color:#cfe6ff; border-radius:.6rem; padding:.55rem .9rem; font-weight:700; cursor:pointer}

  /* Paleta por faixa */
  .r1{color:#b7ffd6;border-color:#b7ffd622;background:#b7ffd614}
  .r2{color:#bfe7ff;border-color:#bfe7ff22;background:#bfe7ff14}
  .r3{color:#e7d1ff;border-color:#e7d1ff22;background:#e7d1ff14}
  .r4{color:#ffd7b3;border-color:#ffd7b322;background:#ffd7b314}
  .r5{color:#ffe7a6;border-color:#ffe7a622;background:#ffe7a614}
  .r6{color:#ffc1c1;border-color:#ffc1c122;background:#ffc1c114}

  /* Box seções */
  .box{margin:.9rem 0;padding:1rem;border:1px solid #1e2b46;border-radius:12px;
       background:linear-gradient(180deg, rgba(19,30,54,.65), rgba(13,20,33,.6));}
  .box-title{margin:0 0 .7rem;font-weight:800;display:flex;align-items:center;gap:.55rem}
  .box-title::before{content:"";width:.7rem;height:.7rem;border-radius:50%;
    background:linear-gradient(135deg,#6bdcff,#b084ff);}

</style>

</head>

<body>
<canvas id="c"></canvas>

<form class="hud" id="form" onsubmit="return false">
  <div class="row"><label for="dob">Data de nascimento</label><input id="dob" type="date" required /></div>
  <button id="startBtn" type="button">Medir meu caos</button>
</form>

<div class="status" id="status" hidden>
  <div class="status-inner">
    <span id="statusText">O pêndulo está medindo o seu caos…</span>
    <span class="timer" id="timer">20</span>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="backdrop">
  <div class="modal">
   
    <div class="modal-body">

      <div class="box">
        
          <h3 class="box-title">Seu contador de caos</h3>
         <div style="display: flex;"> 
          <div class="bigCounter" style="display: flex;" id="bigCounter">0000</div>
          <span class="chip" style="display: flex;" id="rangeBadge">—</span>
        </div>
        <div id="rangeDesc"></div>
      </div>

      <div class="box">
        <h3 class="box-title">Sua influência caótica</h3>
        <div class="influencia">
          <div class="signo"><b>Seu Signo:</b> <span id="signoTrad">—</span></div>
          <div class="seta">→</div>
          <div class="signo"><b>Seu Signo no Caos:</b> <span id="signoChaos">—</span></br>
         
        </div>
        <div id="inflMsg"></div>
      </div>

      <div class="box">
        <h3 class="box-title">Traços do dia</h3>
        <div class="traits" id="traits"></div>
      </div>

      <div class="box">
        <h3 class="box-title">A frase que traduz seu caos hoje é:</h3>
        <div class="fortune" id="fortune"></div>
      </div>

    </div>
    <div class="closebar"><button class="closebtn" id="closeModal">Fechar</button></div>
  </div>
</div>
</div>





<script>
(() => {
  /* ===== Canvas & Trilhas ===== */
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });

  function resize() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = Math.floor(window.innerWidth);
    const h = Math.floor(window.innerHeight);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    trail.resize(w, h, dpr);
  }
  window.addEventListener('resize', resize, { passive:true });

  const trail = (() => {
    let off, octx, dpr=1, w=0, h=0;
    function resizeOff(W,H,DPR){
      dpr=DPR; w=W; h=H;
      off = document.createElement('canvas');
      off.width = Math.floor(W*DPR);
      off.height= Math.floor(H*DPR);
      octx = off.getContext('2d', { alpha:true });
      octx.setTransform(DPR,0,0,DPR,0,0);
      octx.clearRect(0,0,W,H);
    }
    function fade(){ octx.globalCompositeOperation='source-over';
      octx.fillStyle='rgba(11,15,21,0.04)'; octx.fillRect(0,0,w,h); }
    function line(x1,y1,x2,y2,color,width=1.6){
      octx.save(); octx.globalCompositeOperation='lighter';
      octx.lineWidth=width; octx.lineCap='round'; octx.strokeStyle=color;
      octx.beginPath(); octx.moveTo(x1,y1); octx.lineTo(x2,y2); octx.stroke(); octx.restore();
    }
    function dot(x,y,color,r=1.5){
      octx.save(); octx.globalCompositeOperation='lighter';
      octx.fillStyle=color; octx.beginPath(); octx.arc(x,y,r,0,Math.PI*2); octx.fill(); octx.restore();
    }
    function drawTo(ctx2){ ctx2.drawImage(off,0,0,Math.floor(w*dpr),Math.floor(h*dpr),0,0,w,h); }
    return { resize:resizeOff, fade, line, dot, drawTo };
  })();

  /* ===== Física (Verlet + restrições) ===== */
  class Point {
    constructor(x,y,pinned=false){ this.x=x; this.y=y; this.px=x; this.py=y; this.ax=0; this.ay=0; this.pinned=pinned; }
    addForce(fx,fy){ this.ax+=fx; this.ay+=fy; }
    step(dt,damping){
      if(this.pinned){ this.px=this.x; this.py=this.y; this.ax=this.ay=0; return; }
      const nx = this.x + (this.x - this.px)*damping + this.ax*dt*dt;
      const ny = this.y + (this.y - this.py)*damping + this.ay*dt*dt;
      this.px=this.x; this.py=this.y; this.x=nx; this.y=ny; this.ax=this.ay=0;
    }
  }
  class Stick {
    constructor(p0,p1,len){ this.p0=p0; this.p1=p1; this.len=len; }
    satisfy(){
      const dx=this.p1.x-this.p0.x, dy=this.p1.y-this.p0.y;
      const dist=Math.hypot(dx,dy)||1e-8, diff=(dist-this.len)/dist;
      const inv0=this.p0.pinned?0:0.5, inv1=this.p1.pinned?0:0.5;
      const ox=dx*diff, oy=dy*diff;
      this.p0.x+=ox*inv0; this.p0.y+=oy*inv0;
      this.p1.x-=ox*inv1; this.p1.y-=oy*inv1;
    }
  }

  const g = 980*0.12, L1=150,L2=150,L3=150, damping=0.999;
  let originX=0, originY=0, p0,p1,p2,p3, s01,s12,s23;

  function setupPendulum() {
    const W = canvas.clientWidth, H = canvas.clientHeight;
    originX = W*0.5; originY = Math.max(60, H*0.2);
    const a1 = Math.PI*.8, a2 = Math.PI*.9, a3 = Math.PI*.85;
    p0 = new Point(originX, originY, true);
    p1 = new Point(originX + L1*Math.sin(a1), originY + L1*Math.cos(a1));
    p2 = new Point(p1.x + L2*Math.sin(a2),   p1.y + L2*Math.cos(a2));
    p3 = new Point(p2.x + L3*Math.sin(a3),   p2.y + L3*Math.cos(a3));
    p1.px = p1.x - 2; p2.px = p2.x + 1; p3.px = p3.x - 3;
    s01 = new Stick(p0,p1,L1); s12 = new Stick(p1,p2,L2); s23 = new Stick(p2,p3,L3);
  }

  function drawPendulum() {
    ctx.lineCap='round'; ctx.lineWidth=2.2; ctx.strokeStyle='#5b708b';
    ctx.beginPath(); ctx.moveTo(p0.x,p0.y); ctx.lineTo(p1.x,p1.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p2.x,p2.y); ctx.lineTo(p3.x,p3.y); ctx.stroke();
    const circle=(x,y,r,c)=>{ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fillStyle=c;ctx.fill();};
    circle(p0.x,p0.y,4,'#a2b7d6'); circle(p1.x,p1.y,6,'#6bdcff'); circle(p2.x,p2.y,6,'#b084ff'); circle(p3.x,p3.y,6,'#ff7aa2');
  }

  const trail1='#33c6ff', trail2='#9d6bff', trail3='#ff5c8a';

  /* ===== Loop de animação (com aceleração aleatória) ===== */
  let running = false;
  let last = performance.now();
  let speedMul = 1.0; // multiplicador de velocidade (aleatório fixado por dia + DOB)

  function frame(now){
    requestAnimationFrame(frame);
    let dt = Math.min(0.033, (now-last)/1000);
    last=now;

    // aplica aceleração
    dt *= speedMul;

    ctx.fillStyle='#0b0f15'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);

    if(running){
      const steps=2;
      for(let i=0;i<steps;i++){
        p1.addForce(0,g); p2.addForce(0,g); p3.addForce(0,g);
        p1.step(dt/steps,damping); p2.step(dt/steps,damping); p3.step(dt/steps,damping);
        for(let j=0;j<8;j++){ s01.satisfy(); s12.satisfy(); s23.satisfy(); }
      }
      trail.fade();
      trail.line(p1.px,p1.py,p1.x,p1.y,trail1,1.4);
      trail.line(p2.px,p2.py,p2.x,p2.y,trail2,1.4);
      trail.line(p3.px,p3.py,p3.x,p3.y,trail3,1.4);
      trail.dot(p3.x,p3.y,'rgba(255,122,162,0.4)',1.2);
    }
    trail.drawTo(ctx);
    drawPendulum();
  }

  /* ===== Pool único de traços ===== */
  const TRAITS_POOL = [
    'Estratégico','Independente','Cético','Planejamento de longo prazo','Calmo no caos',
    'Analítico','Curioso','Observador','Experimentador','Abstrato',
    'Decisivo','Organizador','Direto','Orientado a metas','Eficiente',
    'Debatedor','Contrário lúdico','Gerador de ideias','Raciocínio rápido','Inquieto',
    'Idealista','Reservado','Busca padrões','Orientado a propósito','Comedido',
    'Valores fortes','Imaginativo','Sensível','Autêntico','Reflexivo',
    'Apoia o grupo','Persuasivo','Articula redes','Visão ampla','Encorajador',
    'Entusiasta','Espontâneo','Conector','Otimista','Exploratório',
    'Responsável','Metódico','Detalhista','Prático','Comprometido',
    'Atencioso','Constante','Serviço ao outro','Cuidadoso','Confiável',
    'Estruturado','Sem rodeios','Coordenador','Foco em resultados','Ordeiro',
    'Comunitário','Afetuoso','Organizado','Anfitrião','Tradicional',
    'Mão na massa','Frio sob pressão','Resolve problemas','Poucas palavras','Adaptável',
    'Criativo discreto','Estético','Gentil','Foco no presente','Flexível',
    'Ação rápida','Pragmático','Corajoso','Improvisa','Vibrante',
    'Expressivo','Gosta de gente','Brincalhão','Aqui e agora','Energético'
  ];

  /* ===== Frases “místicas” ===== */
  const HORO = [
    "Uma incerteza familiar encontra o próprio ritmo",
    "O que era nebuloso parecerá suficiente",
    "O silêncio confortável aumenta os sinais",
    "Caminhos divergem, mas ambos soam corretos",
    "Um padrão antigo veste máscara nova",
    "Coincidências se organizam sem pressa",
    "Uma decisão escolhe você quando desvia o olhar",
    "A resposta aparece ligeiramente à esquerda",
    "Você percebe o que já vinha fazendo",
    "Algo pequeno vira o mais importante",
    "Você entenderá depois, e tudo bem",
    "O óbvio revela uma segunda camada",
    "O tempo importa menos que a direção",
    "O ausência desenha o contorno necessário",
    "O progresso se esconde no canto não medido",
    "Uma porta fechada sugere um corredor melhor",
    "Você reconhece o eco antes do som",
    "A certeza pisca; continue assim mesmo",
    "A restrição correta liberta",
    "O que se repete hoje tem propósito",
    "Você está mais perto do que o mapa indica",
    "A paciência edita o que o esforço não alcança",
    "A pista chega disfarçada de rotina",
    "Deixe o vago ser útil hoje",
    "O acaso está atento às suas escolhas",
    "a pausa mostra mais do que o movimento",
  "Um detalhe esquecido volta com nova cor",
  "O inesperado parece ensaiado",
  "Quando o fim se aproxima, um início acena",
  "Há clareza em aceitar a sombra",
  "O trivial revela sua própria cerimônia",
  "Um ruído distante serve de guia",
  "A dúvida é o atalho mais seguro hoje",
  "Um eco sugere que ainda há passagem",
  "A repetição esconde a diferença essencial",
  "O intervalo guarda mais que o discurso",
  "Um gesto simples reordena o dia",
  "O que se perde indica o que já foi ganho",
  "Uma lembrança esquecida prova presença",
  "O tempo dobrado se endireita sem esforço",
  "Quando tudo parece igual, o contraste se oferece",
  "O acaso prefere quem espera de lado",
  "Um reflexo aponta melhor que um mapa",
  "A linha torta acompanha o traço certo",
  "Um silêncio inesperado vira resposta",
  "A falta de pressa acelera os sinais",
  "A coincidência insiste em se repetir",
  "Um peso leve altera o rumo inteiro",
  "A sombra acompanha mesmo sem luz",
  "Quando não há escolha, há caminho",
  "A espera se torna movimento secreto",
  "Um ruído banal aponta direção nova",
  "A ausência reorganiza a presença",
  "O dia termina antes de começar de fato",
  "Um limite mostra a fronteira maleável",
  "A contradição ensina mais que a certeza",
  "Um gesto atrasado chega no tempo justo",
  "A distração guarda um recado útil",
  "O acaso parece planejado por instantes",
  "Uma curva anuncia a linha reta",
  "A repetição cansada abre brecha de novidade",
  "O que não é dito cresce em importância",
  "Um detalhe esquecido sustenta a cena",
  "A mudança se disfarça de rotina",
  "O imprevisto se veste de familiar",
  "Um fim aparente prepara continuidade",
  "A espera alongada produz clareza breve",
  "O silêncio reorganiza ruídos futuros",
  "Um erro mínimo aponta ajuste essencial",
  "A incerteza acolhe a melhor decisão",
  "Um passo atrás mostra avanço escondido",
  "O vazio revela contorno necessário",
  "A lentidão protege o ritmo real",
  "Um desvio gera sentido imprevisto"
  ];

  /* ===== Signos ===== */
  const SIGNOS = ["Áries","Touro","Gêmeos","Câncer","Leão","Virgem","Libra","Escorpião","Sagitário","Capricórnio","Aquário","Peixes"];

  function signoTropical(dobStr){
    if(!dobStr) return "—";
    const [Y,M,D] = dobStr.split('-').map(Number);
    const m=M,d=D;
    if((m===3 && d>=21) || (m===4 && d<=19)) return "Áries";
    if((m===4 && d>=20) || (m===5 && d<=20)) return "Touro";
    if((m===5 && d>=21) || (m===6 && d<=20)) return "Gêmeos";
    if((m===6 && d>=21) || (m===7 && d<=22)) return "Câncer";
    if((m===7 && d>=23) || (m===8 && d<=22)) return "Leão";
    if((m===8 && d>=23) || (m===9 && d<=22)) return "Virgem";
    if((m===9 && d>=23) || (m===10 && d<=22)) return "Libra";
    if((m===10 && d>=23) || (m===11 && d<=21)) return "Escorpião";
    if((m===11 && d>=22) || (m===12 && d<=21)) return "Sagitário";
    if((m===12 && d>=22) || (m===1 && d<=19)) return "Capricórnio";
    if((m===1 && d>=20) || (m===2 && d<=18)) return "Aquário";
    if((m===2 && d>=19) || (m===3 && d<=20)) return "Peixes";
    return "—";
  }

  // Chaos sign via de/para das faixas (inclui Serpente)
  function chaosSignFromDob(dobStr){
    if(!dobStr) return "—";
    const [Y,M,D] = dobStr.split('-').map(Number);
    const mdays=[31,28,31,30,31,30,31,31,30,31,30,31];
    const mdoy=(mn,dn)=>{ let s=dn; for(let i=0;i<mn-1;i++) s+=mdays[i]; return s; };
    let doy=D; for(let i=0;i<M-1;i++) doy+=mdays[i];

    const starts = [
      {d: mdoy(1,20),  name:"Capricórnio"},
      {d: mdoy(2,16),  name:"Aquário"},
      {d: mdoy(3,11),  name:"Peixes"},
      {d: mdoy(4,18),  name:"Áries"},
      {d: mdoy(5,13),  name:"Touro"},
      {d: mdoy(6,21),  name:"Gêmeos"},
      {d: mdoy(7,20),  name:"Câncer"},
      {d: mdoy(8,10),  name:"Leão"},
      {d: mdoy(9,16),  name:"Virgem"},
      {d: mdoy(10,30), name:"Libra"},
      {d: mdoy(11,23), name:"Escorpião"},
      {d: mdoy(11,29), name:"Serpente"},
      {d: mdoy(12,17), name:"Sagitário"}
    ];
    let idx = starts.length - 1;
    for(let i=0;i<starts.length;i++){
      if(doy >= starts[i].d) idx = i;
    }
    return starts[idx].name;
  }

  /* ===== Ranges e frase ambígua por faixa ===== */
  function rangeInfo(num){
    if(num <= 300)   return { key:'r1', label:'Quase quieto',
      blurb:'Quanto mais discreta a maré do acaso melhor; hoje ela prefere sussurrar.' };
    if(num <= 700)   return { key:'r2', label:'Corrente leve',
      blurb:'O caos segue sem pressa; as coisas tendem a cair no lugar por conta própria.' };
    if(num <= 1100)  return { key:'r3', label:'Ondulação',
      blurb:'Existe uma influência caótica no seu dia, mas ela ainda é gentil; ajustes vão aparecer como convites e não como imposições.' };
    if(num <= 1500)  return { key:'r4', label:'Correnteza',
      blurb:'O fluxo do caos pede pequenas negociações; mas o roteiro topa revisões elegantes.' };
    if(num <= 1800)  return { key:'r5', label:'Turbulência',
      blurb:'O Caos cria arestas criativas hoje; escolhas dançam antes de se assentarem.' };
    return { key:'r6', label:'Ressaca cósmica',
      blurb:'O acaso fala alto; causalidade aparece com sotaque e sentido suficiente.' };
  }

  /* ===== Cache por (dia local + DOB) ===== */
  const localDayStr = () => {
    const d = new Date();
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  };
  const cacheKey = (dob) => `chaos_cache_${localDayStr()}__${dob || 'no-dob'}`;

  function getCached(dob){
    try{ const raw = localStorage.getItem(cacheKey(dob)); return raw ? JSON.parse(raw) : null; }
    catch{ return null; }
  }
  function setCached(dob, obj){
    try{ localStorage.setItem(cacheKey(dob), JSON.stringify(obj)); }catch{}
  }

  /* ===== PRNG determinístico por (dia + DOB) ===== */
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  function hashStr(s){
    let h=2166136261>>>0;
    for(let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h,16777619); }
    return h>>>0;
  }
  function pickDistinct(rng, arr, n){
    const idxs = [...Array(arr.length).keys()];
    for(let i=idxs.length-1;i>0;i--){
      const j=Math.floor(rng()*(i+1)); [idxs[i],idxs[j]]=[idxs[j],idxs[i]];
    }
    return idxs.slice(0,n).map(i=>arr[i]);
  }

  /* ===== UI ===== */
  const startBtn = document.getElementById('startBtn');
  const statusWrap = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const traitsEl = document.getElementById('traits');
  const fortuneEl = document.getElementById('fortune');
  const bigCounterEl = document.getElementById('bigCounter');
  const backdrop = document.getElementById('backdrop');
  const closeModal = document.getElementById('closeModal');
  const signoTradEl = document.getElementById('signoTrad');
  const signoChaosEl = document.getElementById('signoChaos');
  //const badgeChaosEl = document.getElementById('badgeChaos');
  const inflMsgEl = document.getElementById('inflMsg');
  const rangeBadgeEl = document.getElementById('rangeBadge');
  const rangeDescEl  = document.getElementById('rangeDesc');

  function showModal(dob, chaosNum, phraseIdx, traitsList){
    // Signos
    const st = signoTropical(dob);
    const sc = chaosSignFromDob(dob);
    signoTradEl.textContent = st;
    signoChaosEl.textContent = sc;
    const mudou = (st !== sc) && st !== "—" && sc !== "—";
    //badgeChaosEl.style.display = mudou ? 'inline-flex' : 'none';
    inflMsgEl.textContent = mudou
      ? "A força de precessão alterou seu vetor natal: Este é o seu signo verdadeiro sob influência da energia caótica."
      : "Você nasceu sob um arranjo astrológico comum — um ambiente cosmo-interplanar — onde a precessão mal desviou seu vetor natal.";

    // Número + faixa + frase ambígua de faixa
    bigCounterEl.textContent = String(chaosNum);
    const r = rangeInfo(chaosNum);
    rangeBadgeEl.textContent = r.label;
    rangeBadgeEl.className = 'chip ' + r.key;
    rangeDescEl.textContent = r.blurb;

    // Frase “mística” do dia
    const phrase = HORO[phraseIdx % HORO.length];
    fortuneEl.textContent = phrase;

    // Traços (3 itens do pool)
    traitsEl.innerHTML = '';
let normalized = Array.isArray(traitsList) ? traitsList.slice(0,3) : pickDistinct(rng, TRAITS_POOL, 3);
normalized.forEach(t=>{
  const span = document.createElement('span');
  span.className='tag';
  span.textContent = t;
  traitsEl.appendChild(span);
    });

    backdrop.style.display = 'flex';
  }

  /* ===== Execução ===== */
  let countdownTimer = null;

  function startRun(){
    const dob = document.getElementById('dob').value;
    if(!dob){ alert('Selecione sua data de nascimento.'); return; }

    const seed = hashStr(localDayStr() + '|' + dob);
    const rng = mulberry32(seed);

    let cached = getCached(dob);
    if(!cached){
      const chaosNum = Math.floor(rng()*2000) + 1; // 1..2000
      const phraseIdx = Math.floor(rng()*HORO.length);
      const speed = 1.0 + rng()*1.2; // 1.0..2.2
      // 3 traços distintos do pool
      const pick = pickDistinct(rng, TRAITS_POOL, 3);

      cached = { chaosNum, phraseIdx, speedMul: speed, traits: pick };
      setCached(dob, cached);
    }

    // aceleração aleatória
    speedMul = cached.speedMul || 1.0;

    // preparar cena e iniciar
    trail.resize(canvas.clientWidth, canvas.clientHeight, Math.max(1, Math.min(2, window.devicePixelRatio||1)));
    setupPendulum();
    running = true;

    startBtn.disabled = true;
    statusWrap.hidden = false;

    let seconds = 20;
    timerEl.textContent = String(seconds);
    clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      seconds--;
      timerEl.textContent = String(seconds);
      if(seconds <= 0){
        clearInterval(countdownTimer);
        running = false;
        statusWrap.hidden = true;

        showModal(dob, cached.chaosNum, cached.phraseIdx, cached.traits);
        startBtn.disabled = false;
      }
    }, 1000);
  }

  // Init
  resize();
  setupPendulum();
  requestAnimationFrame(frame);

  // Events
  document.getElementById('startBtn').addEventListener('click', () => { if(!startBtn.disabled) startRun(); });
  closeModal.addEventListener('click', () => { backdrop.style.display = 'none'; });

  // Reset pose quando parado (opcional)
  canvas.addEventListener('click', () => { if(!running) setupPendulum(); });
})();
</script>
</body>
</html>
